<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DOA ‚Äî Rapports</title>
<style>
/* --- VARIABLES & STYLES --- */
:root{
  --bg:#071018; --panel:#0f1720; --muted:#b6c7d6; --accent:#ffffff; --glass: rgba(255,255,255,0.03); --white:#e6eef6;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Segoe UI",Roboto,Arial,"Courier New",monospace;background:linear-gradient(180deg,var(--bg),#06111a);color:var(--white);-webkit-font-smoothing:antialiased}
.container{max-width:1200px;margin:20px auto;padding:16px;display:grid;grid-template-columns:1fr 360px;gap:18px;min-height:calc(100vh - 40px)}
.header{grid-column:1/-1;display:flex;align-items:center;gap:12px;padding:14px;border-radius:8px;background:linear-gradient(180deg,var(--panel),#08131a);border:1px solid rgba(255,255,255,0.03)}
.header .branding{display:flex;gap:12px;align-items:center}
.logo{width:78px;height:78px;background:var(--glass);border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
.header h1{font-size:1.3rem;margin:0}
.header .meta{margin-left:auto;text-align:right;font-size:0.9rem;color:var(--muted)}
.panel{background:linear-gradient(180deg,#07121a,#041019);padding:14px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.form{padding:6px}
.section{margin-bottom:14px;padding:10px;border-left:4px solid var(--accent);background:rgba(255,255,255,0.01);border-radius:6px}
.section h2{margin:0 0 8px 0;color:var(--accent);font-size:1rem}
.label{display:block;color:var(--muted);font-size:0.85rem;margin-bottom:6px}
.input,textarea,select{width:100%;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01);color:var(--white);font-size:0.95rem}
textarea{min-height:110px;resize:vertical}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.actions{display:flex;gap:10px;align-items:center}
.btn{padding:10px 12px;border-radius:6px;border:0;background:var(--accent);color:#021827;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--white)}
.small{font-size:0.85rem;color:var(--muted)}
.right-col{display:flex;flex-direction:column;gap:12px}
.meta-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
.meta-item .k{color:var(--muted);font-size:0.85rem}
.meta-item .v{font-weight:800}

/* BOOT overlay */
#bootOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,8,15,0.95), rgba(2,8,15,0.95));z-index:9999;backdrop-filter: blur(2px);}
.boot-card{width:780px;max-width:94%;background:linear-gradient(180deg,#08141b,#051018);padding:18px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 30px 80px rgba(0,0,0,0.7)}
.boot-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
.boot-title{font-weight:800;font-size:1.2rem}
.boot-sub{color:var(--muted);font-size:0.95rem}
.boot-progress{margin-top:14px;height:14px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.02)}
.boot-progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#1f8cc5);transition:width .35s ease}
.boot-percent{float:right;color:var(--muted);font-weight:700;margin-top:8px}
.boot-msg{margin-top:12px;color:var(--muted);font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:rgba(255,255,255,0.01);padding:10px;border-radius:6px}

/* SEND overlay */
#sendOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:997}
.send-card{width:520px;max-width:94%;background:linear-gradient(180deg,#071217,#041018);padding:14px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
.send-progress{height:10px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden}
.send-progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#1f8cc5);transition:width .35s ease}
.send-logs{margin-top:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted);max-height:180px;overflow:auto;padding:8px;background:rgba(255,255,255,0.01);border-radius:6px}
.send-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}

/* responsive */
@media (max-width:1020px){ .container{grid-template-columns:1fr} .right-col{order:2} }
</style>
</head>
<body>

<!-- BOOT Overlay -->
<div id="bootOverlay">
  <div class="boot-card">
    <div class="boot-head">
      <div>
        <div class="boot-title">Initialisation du poste</div>
        <div class="boot-sub">Chargement des donn√©es</div>
      </div>
      <div style="text-align:right">
        <div class="small">Dossier</div>
        <div id="bootDossier" style="font-weight:800">#1000</div>
      </div>
    </div>
    <div class="boot-progress" aria-hidden><i id="bootBar"></i></div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="small">Pr√©paration du poste‚Ä¶</div>
      <div class="boot-percent" id="bootPercent">0%</div>
    </div>
    <div class="boot-msg" id="bootMsg">Initialisation‚Ä¶</div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button class="btn ghost" id="bootSkip"></button>
    </div>
  </div>
</div>

<!-- MAIN LAYOUT -->
<div class="container" id="app">
  <div class="header">
    <div class="branding">
      <div class="logo" id="logoBox"></div>
      <div>
        <h1>D O A </h1>
        <div class="small">Poste MDT ‚Äî Enqu√™tes / Rapports</div>
      </div>
    </div>
    <div class="meta">
      <div class="small">Dossier courant</div>
      <div style="font-weight:800" id="currentDossier">#1000</div>
    </div>
  </div>

  <div>
    <div class="panel">
      <form id="reportForm" class="form" autocomplete="off" spellcheck="false">
        <!-- Identit√© suspect -->
        <div class="section">
          <h2>Identit√© du suspect</h2>
          <div class="grid-2">
            <div><label class="label">Nom *</label><input id="nom" class="input" required/></div>
            <div><label class="label">Pr√©nom *</label><input id="prenom" class="input" required/></div>
          </div>
          <div class="grid-2" style="margin-top:8px">
            <div><label class="label">Sexe</label><input id="sexe" class="input" placeholder="M/F"/></div>
            <div><label class="label">Origine</label><input id="origine" class="input"/></div>
          </div>
        </div>

        <!-- Chefs d'accusation -->
        <div class="section">
          <h2>Chefs d'accusation</h2>
          <label class="label">Chef 1 *</label>
          <textarea id="chef1" class="input" required></textarea>
          <label class="label" style="margin-top:8px">Chef 2 (optionnel)</label>
          <textarea id="chef2" class="input"></textarea>
          <label class="label" style="margin-top:8px">Chef 3 (optionnel)</label>
          <textarea id="chef3" class="input"></textarea>
        </div>

        <!-- R√©sum√© -->
        <div class="section">
          <h2>R√©sum√© de la situation</h2>
          <textarea id="resume" class="input" required placeholder="R√©sum√© clair et factuel‚Ä¶"></textarea>
        </div>

        <!-- Date/Heure -->
        <div class="section">
          <h2>Date / Heure</h2>
          <div class="grid-2">
            <div><label class="label">Heure</label><input id="heure" class="input" readonly/></div>
            <div><label class="label">Date</label><input id="date" class="input" readonly/></div>
          </div>
        </div>

        <!-- Agent principal -->
        <div class="section">
          <h2>Agent principal</h2>
          <div class="grid-2">
            <div><label class="label">Nom *</label><input id="agent1Nom" class="input" required/></div>
            <div><label class="label">Pr√©nom *</label><input id="agent1Prenom" class="input" required/></div>
          </div>
          <div style="margin-top:8px"><label class="label">Matricule *</label><input id="agent1Matricule" class="input" required/></div>
        </div>

        <!-- Photos -->
        <div class="section">
          <h2>Photos / Preuves (URLs)</h2>
          <label class="label">URLs s√©par√©es par virgule (optionnel)</label>
          <textarea id="photos" class="input" placeholder="https://‚Ä¶/evidence1.jpg, https://‚Ä¶/evidence2.jpg"></textarea>
        </div>

        <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
          <button type="submit" class="btn">Soumettre</button>
          <div style="margin-left:auto" class="small">DOA ‚Ä¢ KAMYKAZZ‚Ñ¢</div>
        </div>
      </form>
    </div>
  </div>

  <!-- Right column -->
  <div class="right-col">
    <div class="panel">
      <div class="meta-item"><div><div class="k">Statut</div><div class="v" id="status">Pr√™t</div></div><div class="small">R√©seau DOA</div></div>
      <div class="meta-item"><div><div class="k">Mode</div><div class="v">Op√©rationnel</div></div><div class="small">V4.2</div></div>
      <div class="meta-item"><div><div class="k">Mise √† jour</div><div class="v"></div></div><div class="small">Message simple (non-embed)</div></div>
      <div class="meta-item"><div><div class="k">Mise √† jour</div><div class="v"></div></div><div class="small">Retrait section classification</div></div>
      <div class="meta-item"><div><div class="k">Mise √† jour</div><div class="v"></div></div><div class="small">Refonte de l'interface</div></div>
    </div>
  </div>
</div>

<!-- SEND Overlay -->
<div id="sendOverlay">
  <div class="send-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Transmission ‚Äî MDT</div>
      <div class="small" id="sendState">pr√©paration‚Ä¶</div>
    </div>
    <div class="send-progress" style="margin-top:10px"><i id="sendBar"></i></div>
    <div class="send-logs" id="sendLogs"></div>
    <div class="send-actions">
      <button class="btn ghost" id="cancelSend">Annuler</button>
    </div>
  </div>
</div>

<script>
const WEBHOOK_URL = 'https://discord.com/api/webhooks/1439738511715467416/DDM_yFCBf5HdBL_z3DxfpqFe2xBgi94vFzJL7Ns2-wKgusIU4s7au2jMXi0CWTNj6VVX';
const LOGO_URL = 'https://static.wikia.nocookie.net/gtawiki/images/8/83/DOA_logo_GTA_V.png/revision/latest?cb=20150426213246';
let dossierNum = parseInt(localStorage.getItem('doaDossierNumber')||'1000',10);
document.getElementById('currentDossier').textContent = `#${dossierNum}`;
document.getElementById('bootDossier').textContent = `#${dossierNum}`;
document.getElementById('status').textContent = 'Pr√™t';

if(LOGO_URL){
  const box = document.getElementById('logoBox');
  const img = document.createElement('img');
  img.src = LOGO_URL;
  img.alt = 'logo';
  img.style.maxWidth='100%'; img.style.height='100%'; img.style.objectFit='contain';
  box.appendChild(img);
}

/* ===== BOOT ===== */
const bootBar = document.getElementById('bootBar');
const bootPercent = document.getElementById('bootPercent');
const bootMsg = document.getElementById('bootMsg');
const bootOverlay = document.getElementById('bootOverlay');
const bootSkip = document.getElementById('bootSkip');
let bootProgress = 0;
let bootTimer = null;
function bootStep(){
  bootProgress += Math.floor(Math.random()*12) + 8;
  if(bootProgress > 100) bootProgress = 100;
  bootBar.style.width = bootProgress + '%';
  bootPercent.textContent = bootProgress + '%';
  bootMsg.textContent = (bootProgress < 100) ? 'Chargement des modules‚Ä¶' : 'Poste pr√™t.';
  if(bootProgress >= 100){ clearInterval(bootTimer); setTimeout(()=>{ closeBoot(); }, 550); }
}
function startBoot(){ bootTimer = setInterval(bootStep, 420); }
function closeBoot(){ bootOverlay.style.display = 'none'; document.getElementById('nom').focus(); updateDateTimeFields(); }
bootSkip.addEventListener('click', ()=>{ clearInterval(bootTimer); bootBar.style.width='100%'; bootPercent.textContent='100%'; bootMsg.textContent='D√©marrage forc√©.'; setTimeout(closeBoot,200); });
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && bootOverlay.style.display !== 'none') bootSkip.click(); });
startBoot();

/* ===== DATE & HEURE ===== */
function updateDateTimeFields() {
  const now = new Date();
  document.getElementById('date').value = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()}`;
  document.getElementById('heure').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
}
setInterval(updateDateTimeFields, 60000);

/* ===== ENVOI FORMULAIRE ===== */
const reportForm = document.getElementById('reportForm');
const sendOverlay = document.getElementById('sendOverlay');
const sendLogs = document.getElementById('sendLogs');
const sendBar = document.getElementById('sendBar');
const sendState = document.getElementById('sendState');
const cancelSend = document.getElementById('cancelSend');
let sendAbortController = null;

function logSend(msg){ const d=document.createElement('div'); d.textContent='‚Ä¢ '+msg; sendLogs.appendChild(d); sendLogs.scrollTop = sendLogs.scrollHeight; }

function fetchWithTimeout(url, options={}, timeout=9000){
  const controller = new AbortController();
  const id = setTimeout(()=> controller.abort(), timeout);
  sendAbortController = controller;
  return fetch(url, {...options, signal: controller.signal}).finally(()=>{ clearTimeout(id); sendAbortController = null; });
}

async function sendReport(message){
  try {
    const resp = await fetchWithTimeout(WEBHOOK_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({content: message})
    },10000);
    return resp && resp.ok;
  } catch(e){ return false; }
}

reportForm.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const nom = (document.getElementById('nom').value||'').toUpperCase();
  const prenom = (document.getElementById('prenom').value||'').toUpperCase();
  const sexe = (document.getElementById('sexe').value||'').toUpperCase();
  const origine = (document.getElementById('origine').value||'').toUpperCase();
  const chef1 = document.getElementById('chef1').value||'';
  const chef2 = document.getElementById('chef2').value||'';
  const chef3 = document.getElementById('chef3').value||'';
  const resume = document.getElementById('resume').value||'';
  const agent1Nom = (document.getElementById('agent1Nom').value||'').toUpperCase();
  const agent1Prenom = (document.getElementById('agent1Prenom').value||'').toUpperCase();
  const agent1Mat = (document.getElementById('agent1Matricule').value||'').toUpperCase();
  const photos = (document.getElementById('photos').value||'').split(',').map(s=>s.trim()).filter(Boolean);

  if(!nom||!prenom||!chef1||!resume||!agent1Nom||!agent1Prenom||!agent1Mat){
    alert('Remplis les champs obligatoires.');
    return;
  }

  // Construction du message texte
  let message = `**‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê**\n`;
  message += `**üìã RAPPORT ‚Äî DOSSIER #${dossierNum}**\n`;
  message += `**‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê**\n\n`;
  
  message += `**üë§ SUSPECT**\n`;
  message += `‚û§ Nom: **${prenom} ${nom}**\n`;
  message += `‚û§ Sexe: ${sexe||'N/A'}\n`;
  message += `‚û§ Origine: ${origine||'N/A'}\n\n`;
  
  message += `**‚öñÔ∏è CHEFS D'ACCUSATION**\n`;
  message += `‚û§ ${chef1}\n`;
  if(chef2) message += `‚û§ ${chef2}\n`;
  if(chef3) message += `‚û§ ${chef3}\n`;
  message += `\n`;
  
  message += `**üìù R√âSUM√â**\n`;
  message += `${resume}\n\n`;
  
  message += `**üëÆ AGENT PRINCIPAL**\n`;
  message += `‚û§ ${agent1Prenom} ${agent1Nom} ‚Äî [${agent1Mat}]\n\n`;
  
  message += `**üìÖ DATE / HEURE**\n`;
  message += `‚û§ ${document.getElementById('date').value} √† ${document.getElementById('heure').value}\n\n`;
  
  if(photos.length > 0) {
    message += `**üì∏ PREUVES**\n`;
    photos.forEach((url, i) => {
      message += `‚û§ Photo ${i+1}: ${url}\n`;
    });
    message += `\n`;
  }
  
  message += `**‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê**\n`;
  message += `*Drug Organisation Agency ‚Äî MDT*\n`;
  message += `**‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê**`;

  sendLogs.innerHTML=''; sendBar.style.width='0%'; sendState.textContent='pr√©paration';
  sendOverlay.style.display='flex'; logSend('V√©rification des donn√©es...');
  sendBar.style.width='18%'; await new Promise(r=>setTimeout(r,300));
  logSend('Formatage du message...'); sendBar.style.width='36%'; await new Promise(r=>setTimeout(r,250));
  logSend('Transmission au webhook principal...'); sendBar.style.width='52%'; sendState.textContent='envoi';

  const ok = await sendReport(message);

  sendBar.style.width='100%'; sendState.textContent='succ√®s';
  setTimeout(()=>sendOverlay.style.display='none',800);

  if(ok){ 
    dossierNum++; 
    localStorage.setItem('doaDossierNumber', dossierNum); 
    document.getElementById('currentDossier').textContent=`#${dossierNum}`; 
    document.getElementById('bootDossier').textContent=`#${dossierNum}`; 
    reportForm.reset(); 
    updateDateTimeFields(); 
    alert('Rapport envoy√© avec succ√®s.'); 
  } else { 
    alert('√âchec de l\'envoi ‚Äî v√©rifie ton webhook ou la connexion.'); 
  }
});

cancelSend.addEventListener('click', ()=>{ if(sendAbortController) sendAbortController.abort(); sendOverlay.style.display='none'; });
</script>
</body>
</html>
